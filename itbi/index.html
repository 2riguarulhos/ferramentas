<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de pagamento - ITBI</title>

  <style>
    :root{
      --vinho:#7a1e2c;
      --verde:#2f6b4f;
      --cinza:#f3f4f6;
      --borda:#e5e7eb;
      --texto:#111827;
      --erro-bg:#fde2e2;
      --erro-borda:#fca5a5;
      --erro-texto:#7f1d1d;
      --card:#ffffff;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Aptos", "Aptos Display", "Segoe UI", Arial, sans-serif;
      background: var(--cinza);
      color: var(--texto);
    }

    .container{
      max-width: 1080px;
      margin: 32px auto;
      padding: 0 16px;
    }

    .card{
      background: var(--card);
      border-radius: 18px;
      border: 1px solid var(--borda);
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      padding: 26px;
    }

    h1{
      margin: 0;
      font-size: 34px;
      color: var(--vinho);
      font-weight: 800;
      letter-spacing: .2px;
    }

    .linha{
      margin-top: 10px;
      height: 3px;
      width: 100%;
      background: var(--vinho);
      border-radius: 99px;
      opacity: .9;
    }

    .erro{
      margin-top: 18px;
      background: var(--erro-bg);
      border: 1px solid var(--erro-borda);
      color: var(--erro-texto);
      border-radius: 12px;
      padding: 14px 16px;
      display: none;
      position: relative;
      font-weight: 600;
      line-height: 1.25;
    }

    .erro small{
      display:block;
      margin-top:6px;
      font-weight: 500;
      opacity:.9;
    }

    .erro .fechar{
      position:absolute;
      right: 12px;
      top: 10px;
      cursor:pointer;
      font-size:18px;
      font-weight:900;
      opacity:.7;
      user-select:none;
    }

    label{
      display:block;
      margin-top: 18px;
      font-weight: 700;
      color:#111827;
    }

    input[type="text"]{
      width: 100%;
      margin-top: 8px;
      padding: 16px 16px;
      font-size: 16px;
      border-radius: 14px;
      border: 1px solid var(--borda);
      outline: none;
      transition: 0.15s;
      background:#fff;
    }

    input[type="text"]:focus{
      border-color: rgba(122,30,44,.45);
      box-shadow: 0 0 0 4px rgba(122,30,44,.12);
    }

    .botoes{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 18px;
    }

    button{
      padding: 16px 18px;
      border-radius: 14px;
      border: 1px solid var(--borda);
      font-size: 18px;
      font-weight: 800;
      cursor:pointer;
      transition: 0.15s;
      background:#fff;
    }

    button#btnVerificar{
      background: var(--verde);
      color: #fff;
      border: none;
    }
    button#btnVerificar:hover{ filter: brightness(0.95); }
    button#btnLimpar:hover{ background:#f8fafc; }

    .resultado-box{
      margin-top: 18px;
      border-radius: 16px;
      border: 1px solid var(--borda);
      min-height: 330px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      overflow:hidden;
    }

    .resultado-box .placeholder{
      color:#6b7280;
      font-weight:600;
      text-align:center;
      padding: 24px;
    }

    .resultado-box img{
      width: 100%;
      height: auto;
      display:none;
    }

    .como{
      margin-top: 24px;
      border-radius: 16px;
      border: 1px solid var(--borda);
      background:#fff;
      padding: 18px;
    }

    .como h2{
      margin:0;
      color: var(--vinho);
      font-size: 18px;
      font-weight: 900;
    }

    .como p{
      margin: 10px 0 0 0;
      color:#111827;
      font-weight: 600;
    }

    .como ul{
      margin: 10px 0 0 18px;
      padding:0;
      color:#111827;
      font-weight: 600;
    }

    .badge{
      display:inline-block;
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(47,107,79,.12);
      color: var(--verde);
      margin-top: 12px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>Consulta de pagamento - ITBI</h1>
      <div class="linha"></div>

      <div class="erro" id="boxErro">
        <div id="txtErro">Erro</div>
        <small id="txtDetalhe"></small>
        <div class="fechar" id="btnFecharErro">×</div>
      </div>

      <label for="nossoNumero">Nosso Número</label>
      <input type="text" id="nossoNumero" placeholder="Digite o Nosso Número" autocomplete="off" />

      <div class="botoes">
        <button id="btnVerificar">Verificar</button>
        <button id="btnLimpar">Limpar</button>
      </div>

      <div class="resultado-box" id="resultadoBox">
        <div class="placeholder" id="placeholder">
          O resultado vai aparecer aqui.
          <div class="badge">Prévia do print do portal da Prefeitura</div>
        </div>
        <img id="imgResultado" alt="Resultado ITBI" />
      </div>

      <div class="como">
        <h2>Como funciona a ferramenta</h2>
        <p>
          Esta ferramenta consulta automaticamente a <b>situação do pagamento</b> no portal da Prefeitura de Guarulhos,
          utilizando o campo <b>Nosso Número</b>.
        </p>
        <ul>
          <li>Acessa o portal de validação</li>
          <li>Preenche o Nosso Número</li>
          <li>Clica em “Verificar”</li>
          <li>Abre o resultado em popup</li>
          <li>Gera um print e exibe aqui</li>
        </ul>
      </div>

    </div>
  </div>

  <script>
    // ============================
    // CONFIG
    // ============================
    // Troca só isso se mudar IP/porta
    const API_BASE = "http://192.168.0.37:5056";

    // ============================
    // ELEMENTOS
    // ============================
    const inputNossoNumero = document.getElementById("nossoNumero");
    const btnVerificar = document.getElementById("btnVerificar");
    const btnLimpar = document.getElementById("btnLimpar");

    const boxErro = document.getElementById("boxErro");
    const txtErro = document.getElementById("txtErro");
    const txtDetalhe = document.getElementById("txtDetalhe");
    const btnFecharErro = document.getElementById("btnFecharErro");

    const imgResultado = document.getElementById("imgResultado");
    const placeholder = document.getElementById("placeholder");

    // ============================
    // HELPERS
    // ============================
    function showErro(msg, detalhe = "") {
      txtErro.textContent = msg;
      txtDetalhe.textContent = detalhe || "";
      boxErro.style.display = "block";
    }

    function hideErro() {
      boxErro.style.display = "none";
      txtErro.textContent = "";
      txtDetalhe.textContent = "";
    }

    function setLoading(isLoading) {
      btnVerificar.disabled = isLoading;
      btnLimpar.disabled = isLoading;
      btnVerificar.textContent = isLoading ? "Consultando..." : "Verificar";
    }

    function limparResultado() {
      imgResultado.src = "";
      imgResultado.style.display = "none";
      placeholder.style.display = "block";
    }

    // ============================
    // EVENTOS
    // ============================
    btnFecharErro.addEventListener("click", hideErro);

    btnLimpar.addEventListener("click", () => {
      hideErro();
      inputNossoNumero.value = "";
      limparResultado();
      inputNossoNumero.focus();
    });

    btnVerificar.addEventListener("click", async () => {
      hideErro();

      let nossoNumero = (inputNossoNumero.value || "").trim();
      nossoNumero = nossoNumero.replace(/\D/g, "");

      if (!nossoNumero || nossoNumero.length < 6) {
        showErro("Nosso Número inválido.", "Digite um número válido (mínimo 6 dígitos).");
        return;
      }

      setLoading(true);
      limparResultado();

      try {
        const resp = await fetch(`${API_BASE}/api/consultar_itbi`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nosso_numero: nossoNumero,
            nossoNumero: nossoNumero
          })
        });

        const data = await resp.json().catch(() => null);

        // ✅ ALTERAÇÃO MÍNIMA: agora lê as chaves certas do server.py
        if (!resp.ok || !data?.ok) {
          const msg = data?.error || "Falha ao consultar ITBI.";
          const detalhe = data?.details || `HTTP ${resp.status}`;
          showErro(msg, detalhe);
          setLoading(false);
          return;
        }

        // ✅ ALTERAÇÃO MÍNIMA: agora usa preview_url (e não "arquivo")
        if (!data?.preview_url) {
          showErro("Resposta inválida do servidor.", "Não veio o link da imagem do resultado.");
          setLoading(false);
          return;
        }

        // ✅ ALTERAÇÃO MÍNIMA: monta a URL final certa
        const urlImagem = `${API_BASE}${data.preview_url}?t=${Date.now()}`;

        imgResultado.onload = () => {
          placeholder.style.display = "none";
          imgResultado.style.display = "block";
        };

        imgResultado.onerror = () => {
          showErro("Não consegui carregar a imagem do resultado.", "Pode ser bloqueio de rede ou a imagem não existe mais.");
          limparResultado();
        };

        imgResultado.src = urlImagem;

      } catch (err) {
        console.error(err);
        showErro("Falha de comunicação com o servidor (API).", String(err));
      } finally {
        setLoading(false);
      }
    });

    // Enter pra pesquisar
    inputNossoNumero.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnVerificar.click();
    });
  </script>
</body>
</html>
